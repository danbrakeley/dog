<!DOCTYPE html>
<html>
<head>
<!-- Required meta tags -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

<title>{{.AppBase}} - {{.AppPath}}</title>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="static/bootstrap-4.5.2.min.css" />

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="static/jquery-3.5.1.slim.min.js"></script>
<script src="static/popper-1.16.1.min.js"></script>
<script src="static/bootstrap-4.5.2.min.js"></script>

<style>
#status_alert {
  padding-top: 0.2rem;
  padding-bottom: 0.3rem;
  margin-bottom: 0rem;
}
</style>

<script>
window.addEventListener("load", (event) => {
  var ws;
  const text_log = document.getElementById("text-log");
  const text_input = document.getElementById("text-input");
  const status_alert = document.getElementById("status_alert");
  const status_msg = document.getElementById("status_msg");
  const history = [];
  const display_max = 1000;

  const update_log = function() {
    const start = Math.max(0, history.length - display_max);
    const tail = history.slice(start, start + display_max);
    text_log.value = tail.join("\n");
    text_log.scrollTop = text_log.scrollHeight;
  };

  const print = (msg) => {
    history.push(msg);
    update_log();
  }

  const connection_status= {
    CONNECTING: 'connecting',
    OK: 'ok',
    CLOSED: 'closed',
  }
  let status = null;
  const update_connection_status = (new_status) => {
    if (status != null && status == new_status) {
      return;
    }
    switch (status) {
    case connection_status.CONNECTING:
      status_alert.classList.remove('alert-warning');
      break;
    case connection_status.OK:
      status_alert.classList.remove('alert-primary');
      break;
    case connection_status.CLOSED:
      status_alert.classList.remove('alert-danger');
      break;
    }
    status = new_status;
    switch (status) {
    case connection_status.CONNECTING:
      status_alert.classList.add('alert-warning');
      status_msg.textContent = "Status: opening connection to {{.HostName}}..."
      break;
    case connection_status.OK:
      status_alert.classList.add('alert-primary');
      status_msg.textContent = "Status: connected to {{.HostName}} âœ“"
      break;
    case connection_status.CLOSED:
      status_alert.classList.add('alert-danger');
      status_msg.textContent = "Status: lost connection to {{.HostName}}, will retry..."
      break;
    }
  }

  const open = (event) => {
    if (ws) {
      return false;
    }
    update_connection_status(connection_status.CONNECTING);
    ws = new WebSocket("{{.WsAddr}}");
    ws.onopen = function(event) {
      update_connection_status(connection_status.OK);
    }
    ws.onclose = function(event) {
      update_connection_status(connection_status.CLOSED);
      ws = null;
      const retryMs = 1000 + (Math.random() * 2000);
      setTimeout(open, retryMs);
    }
    ws.onmessage = function(event) {
      print(event.data);
    }
    return false;
  };

  const send = (msg) => {
    console.log('send called with: ', msg);
    if (!ws) {
      return false;
    }
    ws.send(msg);
    return true;
  }

  document.getElementById("button-send").onclick = (event) => {
    send(text_input.value);
    return false;
  };

  text_input.addEventListener('keyup', ({key}) => {
    if (key === "Enter") {
      console.log('keyup: pressed Enter');
      send(text_input.value);
      return true;
    }
    return false;
  });

  open();
});
</script>
</head>
<body>
<div class="container-fluid">

<div class="row">
  <div class="col">
    <div class="d-flex align-items-center justify-content-between">
      <h2>{{.AppBase}}</h2>
      <div id="status_alert" class="alert alert-primary" role="alert">
        <small id="status_msg">Connection Status: Connecting...</small>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-8">
    <div class="input-group mb-3">
      <input id="text-input" class="form-control" type="text" aria-describedby="button-send">
      <div class="input-group-append">
        <button id="button-send" class="btn btn-primary" type="button">Send</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col">
    <div class="form-group">
      <textarea class="form-control rounded-0" id="text-log" rows="10"></textarea>
    </div>
  </div>
</div>

</div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta tags -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
  <meta name="viewport" content="width=device-width" />

  <!-- Favicon and title -->
  <link rel="icon" href="path/to/fav.png">
  <title>{{.AppBase}} (dog)</title>

  <link href="static/halfmoon-variables-1.1.1.min.css" rel="stylesheet" />
  <script src="static/halfmoon-1.1.1.min.js"></script>

  <style>
  /* Remove the "circle with slash" no icon for disabled fields */
  .form-control.disabled,
  .form-control:disabled,
  .form-control.disabled:hover,
  .form-control:disabled:hover {
      cursor: auto;
      opacity: 1.0;
      color: var(--input-text-color);
  }

  /* Log line formatting */
  .fixed-width-font {
    font-family: SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    font-size: var(--code-font-size);
  }
  .smaller-font-size {
    font-size: var(--code-font-size);
  }

  /* Color tweaks */

  body:not(.dark-mode) {
    --lm-base-body-bg-color: #E3E5E8;
    --lm-sidebar-bg-color: #F2F3F5;
  }

  /* Log line text by level - dark mode */
  .dark-mode .row-text-transient { color: var(--dm-muted-text-color) !important; }
  .dark-mode .row-text-verbose   { color: var(--dm-muted-text-color) !important; }
  .dark-mode .row-text-info      { color: var(--dm-base-text-color) !important; }
  .dark-mode .row-text-warning   { color: var(--secondary-color) !important; }
  .dark-mode .row-text-error     { color: var(--danger-color) !important; }
  .dark-mode .row-text-fatal     { color: var(--danger-color) !important; }
  /* Log line row highlights - dark mode */
  .dark-mode .row-fatal { background-color: var(--dark-color-dark); border-radius: 10px; }

  /* Log line text by level - light mode */
  body:not(.dark-mode) .row-text-transient { color: var(--lm-muted-text-color) !important; }
  body:not(.dark-mode) .row-text-verbose   { color: var(--lm-muted-text-color) !important; }
  body:not(.dark-mode) .row-text-info      { color: var(--lm-base-text-color) !important; }
  body:not(.dark-mode) .row-text-warning   { color: var(--lm-base-text-color) !important; }
  body:not(.dark-mode) .row-text-error     { color: var(--lm-base-text-color) !important; }
  body:not(.dark-mode) .row-text-fatal     { color: var(--lm-base-text-color) !important; }
  /* Log line row highlights - light mode */
  body:not(.dark-mode) .row-warning { background-color: #FFFF0030; border-radius: 10px; }
  body:not(.dark-mode) .row-error   { background-color: #FF000030; border-radius: 10px; }
  body:not(.dark-mode) .row-fatal   { background-color: #FF000080; border-radius: 10px; }

  </style>
  
  <script>
  window.addEventListener('load', (event) => {
    const dlog = function(...args) {
      // comment out to disable debug logs
      console.log(...args);
    }

    var ws;
    const status_alert = document.getElementById('status_alert');
    const status_msg = document.getElementById('status_msg');
    const input_history_len = document.getElementById('input-history-len');
    const input_num_visible = document.getElementById('input-num-visible');
    const switches = {
      show_line: document.getElementById('switch-show-line'),
      show_timestamp: document.getElementById('switch-show-timestamp'),
      show_level: document.getElementById('switch-show-level'),
      filter_transient: document.getElementById('switch-filter-transient'),
      filter_verbose: document.getElementById('switch-filter-verbose'),
      filter_info: document.getElementById('switch-filter-info'),
      filter_warning: document.getElementById('switch-filter-warning'),
      filter_error: document.getElementById('switch-filter-error'),
    }
    const input_test = document.getElementById('input-test');
    const log_line_parent = document.getElementById('log-line-parent');
    const history = [];
    let display_max = parseInt(input_num_visible.value, 10);

    const fmt_time = new Intl.DateTimeFormat('en-US', {
      hour: 'numeric', minute: 'numeric', second: 'numeric',
      hour12: false, fractionalSecondDigits: 3,
    }).format;

    // source: https://hackernoon.com/copying-text-to-clipboard-with-javascript-df4d4988697f
    const copyToClipboard = str => {
      const el = document.createElement('textarea');  // Create a <textarea> element
      el.value = str;                                 // Set its value to the string that you want copied
      el.setAttribute('readonly', '');                // Make it readonly to be tamper-proof
      el.style.position = 'absolute';
      el.style.left = '-9999px';                      // Move outside the screen to make it invisible
      document.body.appendChild(el);                  // Append the <textarea> element to the HTML document
      const selected =
        document.getSelection().rangeCount > 0        // Check if there is any content selected previously
          ? document.getSelection().getRangeAt(0)     // Store selection if found
          : false;                                    // Mark as false to know no selection existed before
      el.select();                                    // Select the <textarea> content
      document.execCommand('copy');                   // Copy - only works as a result of a user action (e.g. click events)
      document.body.removeChild(el);                  // Remove the <textarea> element
      if (selected) {                                 // If a selection existed before copying
        document.getSelection().removeAllRanges();    // Unselect everything on the HTML document
        document.getSelection().addRange(selected);   // Restore the original selection
      }
    };

    // const saveHistoryToFile = () => {
    //   const now = new Date(Date.now());

    //   let appName = `{{.AppBase}}`.replace(/\.exe$/g, '');
    //   if (appName.length < 1) {
    //     appName = 'history';
    //   }

    //   const year = ''+now.getFullYear();
    //   const month = now.getMonth()+1;
    //   const paddedMonth = month < 10 ? '0'+month : ''+month;
    //   const day = now.getDate();
    //   const paddedDay = day < 10 ? '0'+day : ''+day;

    //   window.saveAs(
    //     new Blob([history.map(h => JSON.stringify(h.obj)).join('\n')], {type: "text/plain;charset=utf-8"}),
    //     `${appName}-${year}.${paddedMonth}.${paddedDay}.ndjson`,
    //   );
    // }

    const clear_log_dom = () => {
      let next = log_line_parent.firstElementChild;
      while (next) {
        let cur = next;
        next = next.nextSibling
        log_line_parent.removeChild(cur);
      }
    };

    const update_log_dom = () => {
      dlog('update_log_dom', {
        display_max, history_length:history.length,
        scrollHeight:scroll_parent.scrollHeight,
        scrollTop:scroll_parent.scrollTop,
        clientHeight:scroll_parent.clientHeight,
      });

      const wasAtBottom = (scroll_parent.scrollHeight <= (scroll_parent.scrollTop + scroll_parent.clientHeight));

      const start = Math.max(0, history.length - display_max);
      const end = Math.min(history.length, start + display_max);

      let first = 0;
      let firstChild = log_line_parent.firstElementChild;
      if (firstChild) {
        first = parseInt(firstChild.id.replace('log-line-', ''), 10);
      }

      let last = 0;
      let lastChild = log_line_parent.lastElementChild;
      if (lastChild) {
        last = parseInt(lastChild.id.replace('log-line-', ''), 10) + 1;
      }

      dlog('update_log_dom', {first, last, start, end, wasAtBottom});

      // remove lines we no longer wish to see
      for (let i = first; i < last; i++) {
        let e = document.getElementById(`log-line-${i}`);
        if (e) {
          let h = history[i];
          if (i >= start && i < end && h && h.visible === true) {
            continue;
          }
          dlog(`removing ${e.id}`);
          log_line_parent.removeChild(e);
        }
      }

      // add lines we want to see but aren't there
      let ePrev = null;
      for (let i = start; i < end; i++) {
        let h = history[i];
        if (!h || h.visible === false) {
          // skip invisible lines
          continue;
        }

        let e = document.getElementById(`log-line-${i}`);
        if (e) {
          ePrev = e;
          // skip lines that already exist
          // note: this assumes the contents of specific lines in history never changes
          continue;
        }

        dlog(`appending visible log-line-${i}`);

        let row = document.createElement('div');
        row.id = `log-line-${i}`;
        row.classList.add('row');
        row.classList.add(`row-${h.obj.level}`);

        let colMsgWidth = 12;

        if (switches.show_line.checked) {
          let colNum = document.createElement('div');
          colNum.classList.add('col-1');
          colNum.classList.add('text-center');
          colNum.classList.add('fixed-width-font');
          colNum.classList.add(`row-text-${h.obj.level}`);
          colNum.appendChild(document.createTextNode(i+1));
          row.appendChild(colNum);
          colMsgWidth -= 1;
        }

        if (switches.show_timestamp.checked) {
          let colDate = document.createElement('div');
          colDate.classList.add(`col-1`);
          colDate.classList.add('text-center');
          colDate.classList.add('fixed-width-font');
          let colDateRef = document.createElement('a');
          colDateRef.classList.add(`row-text-${h.obj.level}`);
          colDateRef.classList.add('text-decoration-none');
          colDateRef.href = 'no-javascript.html';
          colDateRef.title = `${h.date.toDateString()}, ${h.date.toTimeString()}\n`+
            '-- click to copy ISO 8601 timestamp to clipboard --';
          colDateRef.appendChild(document.createTextNode(fmt_time(h.date)));
          colDateRef.onclick = () => {
            copyToClipboard(h.date.toISOString());
            return false;
          }
          colDate.appendChild(colDateRef);
          row.appendChild(colDate);
          colMsgWidth -= 1;
        }

        if (switches.show_level.checked) {
          let colLevel = document.createElement('div');
          colLevel.classList.add('col-1');
          colLevel.classList.add('text-center');
          colLevel.classList.add('fixed-width-font');
          colLevel.classList.add(`row-text-${h.obj.level}`);
          colLevel.appendChild(document.createTextNode(h.obj.level));
          row.appendChild(colLevel);
          colMsgWidth -= 1;
        }

        let colMsg = document.createElement('div');
        colMsg.classList.add(`col-${colMsgWidth}`);
        colMsg.classList.add('fixed-width-font');
        colMsg.classList.add(`row-text-${h.obj.level}`);
        colMsg.appendChild(document.createTextNode(h.obj.msg));
        row.appendChild(colMsg);

        if (!ePrev) {
          ePrev = log_line_parent.firstElementChild;
          log_line_parent.insertBefore(row, ePrev);
        } else {
          log_line_parent.insertBefore(row, ePrev.nextSibling);
        }
        ePrev = row;
      }

      if (wasAtBottom) {
        const isAtBottom = (scroll_parent.scrollHeight <= (scroll_parent.scrollTop + scroll_parent.clientHeight));
        dlog('was at bottom:', {isAtBottom});
        if (!isAtBottom) {
          scroll_parent.scrollTo(0, scroll_parent.scrollHeight - scroll_parent.clientHeight);
        }
      }

    }

    const matches_any_filter = (e) => {
      if (switches.filter_transient.checked && e.obj.level=='transient') return true;
      if (switches.filter_verbose.checked && e.obj.level=='verbose') return true;
      if (switches.filter_info.checked && e.obj.level=='info') return true;
      if (switches.filter_warning.checked && e.obj.level=='warning') return true;
      if (switches.filter_error.checked && e.obj.level=='error') return true;
      return false;
    }

    const add_to_history = (obj) => {
      const e = {
        visible: false,
        date: new Date(obj.timestamp),
        obj: obj,
      }
      e.visible = matches_any_filter(e);
      history.push(e);

      input_history_len.value = history.length;
    }

    const recalculate_visibility = () => {
      const count = Math.min(history.length, display_max);
      const start = Math.max(0, history.length - count);
      const end = start + count;
      dlog('recalculate_visibility', {count, start, end});
      for (let i = start; i < end; i++) {
        history[i].visible = matches_any_filter(history[i]);
      }
    }

    const connection_status= {
      CONNECTING: 'connecting',
      OK: 'ok',
      CLOSED: 'closed',
    }
    let status = null;
    const update_connection_status = (new_status) => {
      if (status != null && status == new_status) {
        return;
      }
      switch (status) {
      case connection_status.CONNECTING:
        status_alert.classList.remove('alert-secondary');
        break;
      case connection_status.OK:
        status_alert.classList.remove('alert-primary');
        break;
      case connection_status.CLOSED:
        status_alert.classList.remove('alert-danger');
        break;
      }
      status = new_status;
      switch (status) {
      case connection_status.CONNECTING:
        status_alert.classList.add('alert-secondary');
        status_msg.textContent = 'opening connection to {{.HostName}}...'
        break;
      case connection_status.OK:
        status_alert.classList.add('alert-primary');
        status_msg.textContent = 'connected to {{.HostName}} ✓'
        break;
      case connection_status.CLOSED:
        status_alert.classList.add('alert-danger');
        status_msg.textContent = 'lost connection to {{.HostName}}, will retry...'
        break;
      }
    }
  
    const open = (event) => {
      if (ws) {
        return false;
      }
      update_connection_status(connection_status.CONNECTING);
      ws = new WebSocket('{{.WsAddr}}');
      ws.onopen = function(event) {
        dlog('websocket opened to {{.WsAddr}}');
        update_connection_status(connection_status.OK);
      }
      ws.onclose = function(event) {
        dlog('websocket closed');
        update_connection_status(connection_status.CLOSED);
        ws = null;
        const retryMs = 1000 + (Math.random() * 2000);
        setTimeout(open, retryMs);
      }
      ws.onmessage = function(event) {
        dlog('websocket message received');
        let obj = JSON.parse(event.data);
        dlog('-- parsed json: ', obj);
        add_to_history(obj);
        update_log_dom();
      }
      return false;
    };
  
    const send = (msg) => {
      dlog('send', msg);
      if (!ws) {
        return false;
      }
      dlog('send for real', msg);
      ws.send(msg);
      return true;
    }

    /** Input Handlers **/

    const switch_column = (event) => {
      clear_log_dom();
      update_log_dom();
      return true;
    };
    switches.show_line.onclick = switch_column;
    switches.show_timestamp.onclick = switch_column;
    switches.show_level.onclick = switch_column;

    const switch_filter = (event) => {
      recalculate_visibility();
      update_log_dom();
      return true;
    };
    switches.filter_transient.onclick = switch_filter;
    switches.filter_verbose.onclick = switch_filter;
    switches.filter_info.onclick = switch_filter;
    switches.filter_warning.onclick = switch_filter;
    switches.filter_error.onclick = switch_filter;

    input_num_visible.addEventListener('keyup', ({key}) => {
      if (key === 'Enter') {
        display_max = parseInt(input_num_visible.value, 10);
        input_num_visible.value = display_max;
        recalculate_visibility();
        update_log_dom();
        return true;
      }
      return false;
    });

    // document.getElementById('button-save').onclick = (event) => {
    //   dlog('button-save clicked', event);
    //   saveHistoryToFile();
    //   return false;
    // }

    document.getElementById('button-test').onclick = (event) => {
      dlog('button-test clicked', event);
      send(input_test.value);
      return false;
    };
  
    input_test.addEventListener('keyup', ({key}) => {
      if (key === 'Enter') {
        send(input_test.value);
        return true;
      }
      return false;
    });

    window.addEventListener('scroll', function() {
      dlog(`window scroll event: ${window.pageYOffset + 'px'}`);
    });

    const scroll_parent = document.getElementById('scroll-parent')
    scroll_parent.onscroll = (event) => {
      dlog(`scroll-parent onscroll event: scrollHeight=${scroll_parent.scrollHeight}, scrollTop=${scroll_parent.scrollTop}, clientHeight=${scroll_parent.clientHeight}`);
    }

    /** Init **/

    open();

    add_to_history({timestamp:new Date(Date.now()).toISOString(), level:'info', msg:'----- Start of History -----'});
    update_log_dom();

  });
  </script>

</head>
<body class="dark-mode with-custom-webkit-scrollbars with-custom-css-scrollbars" data-dm-shortcut-enabled="true" data-sidebar-shortcut-enabled="true" data-set-preferred-mode-onload="true">
  <!-- Modals go here -->
  <!-- Reference: https://www.gethalfmoon.com/docs/modal -->

  <!-- Page wrapper start -->
  <div class="page-wrapper with-sidebar" data-sidebar-type="full-height">

    <!-- Sidebar start -->
    <div class="sidebar">
      <!-- Reference: https://www.gethalfmoon.com/docs/sidebar -->

      <div class="sidebar-content">

        <h1 class="content-title font-size-22">
          {{.AppBase}}
        </h1>

        <div id="status_alert" class="alert mb-10" role="alert">
          <small id="status_msg">Javascript not running</small>
        </div>

        <!-- <button id="button-save" class="btn btn-primary" type="button">Save Log to File...</button> -->

        <h2 class="font-size-16 mt-20 mb-5">Log Lines</h2>

        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">In Memory:</span>
          </div>
          <input id="input-history-len" type="text" value="0" class="form-control" disabled="disabled">
        </div>

        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">Currently Visible:</span>
          </div>
          <input id="input-num-visible" type="text" value="1000" class="form-control">
        </div>

        <h2 class="font-size-16 mt-20 mb-5">Columns</h2>

        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-show-line" value="">
          <label for="switch-show-line">Show Line Number</label>
        </div>

        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-show-timestamp" value="" checked='checked'>
          <label for="switch-show-timestamp">Show Date/Time</label>
        </div>

        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-show-level" value="" checked='checked'>
          <label for="switch-show-level">Show Log Level</label>
        </div>

        <h2 class="font-size-16 mt-20 mb-5">Filters</h2>

        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-filter-transient" value="">
          <label for="switch-filter-transient">Include Level Transient</label>
        </div>
        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-filter-verbose" value="">
          <label for="switch-filter-verbose">Include Level Verbose</label>
        </div>
        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-filter-info" value="" checked='checked'>
          <label for="switch-filter-info">Include Level Info</label>
        </div>
        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-filter-warning" value="" checked='checked'>
          <label for="switch-filter-warning">Include Level Warning</label>
        </div>
        <div class="custom-switch mb-5">
          <input type="checkbox" id="switch-filter-error" value="" checked='checked'>
          <label for="switch-filter-error">Include Level Error</label>
        </div>

        <h2 class="font-size-16 mt-20 mb-5">Debug</h2>

        <div class="input-group">
          <input id="input-test" type="text" value="Test Message" class="form-control">
          <button id="button-test" class="btn btn-primary" type="button">Send</button>
        </div>

      </div>
    </div>
    <!-- Sidebar end -->

    <!-- Content wrapper start -->
    <div id="scroll-parent" class="content-wrapper">
      <div class="container-fluid">
        <div id="log-line-parent" class="content">
        </div>
      </div>
    </div>
    <!-- Content wrapper end -->

  </div>
  <!-- Page wrapper end -->

</body>
</html>
